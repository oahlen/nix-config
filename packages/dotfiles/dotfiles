#!/usr/bin/env bash

usage() {
  echo "Usage: $0 [install|uninstall]"
  exit 1
}

install_dotfile() {
  local source_file="$1"
  local target_file="$2"
  local source_path="$FLAKE/config/$source_file"
  local target_path="$HOME/$target_file"

  if [ ! -e "$source_path" ]; then
    echo "Error: Source file $source_path does not exist." >&2
    return 1
  fi

  echo "Installing $source_path to $target_path"
  mkdir -p "$(dirname "$target_path")"
  ln -sf "$source_path" "$target_path"
}

uninstall_dotfile() {
  local target_file="$1"
  local target_path="$HOME/$target_file"
  echo "Removing $target_path"
  rm -f "$target_path"
}

[ $# -eq 2 ] || usage

action="$1"
manifest="$2"

files=()

if [ -f "$manifest" ]; then
  while IFS= read -r line; do
    [ -n "$line" ] || continue
    files+=("$line")
  done < "$manifest"
else
  echo "Manifest $manifest not found." >&2
  exit 1
fi

case "$action" in
  install)
    for entry in "${files[@]}"
    do
      source="${entry%%=*}"
      target="${entry#*=}"
      install_dotfile "$source" "$target"
    done
  ;;

  uninstall)
    for entry in "${files[@]}"
    do
      target="${entry#*=}"
      uninstall_dotfile "$target"
    done
  ;;

  *)
    usage
  ;;
esac
